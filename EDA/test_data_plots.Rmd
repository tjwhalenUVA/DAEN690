---
title: "Hyperpartisan Validation Data EDA"
author: "Jake Whalen"
date: "February 21, 2019"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE,
                      fig.width = 8, fig.height = 4, dpi = 600)
library(DBI)
library(RSQLite)
library(tidyverse)
library(gridExtra)
library(rstudioapi)
```

```{r}
db.file <- sprintf("%s/%s", str_replace(getwd(), 'EDA', 'Article Collection'),
                   "articles_zenodo.db")
```

```{r}
con <- dbConnect(SQLite(), dbname=db.file)
```

```{r}
lean <- dbGetQuery(con,'select * from test_lean')
```

```{r}
content <- dbGetQuery(con,'select * from test_content')
```

```{r}
#Get mbfc leanings
mbfc <- dbGetQuery(con,'select * from mbfc_lean')
dbDisconnect(con)
```

```{r}
bias.levels <- c('left', 'left-center', 'least', 'right-center', 'right')
```

#  Political Lean

### Count of Articles in Leaning Categories

```{r}
#Plot the bias
bias.cnt <-
    lean %>%
    mutate(bias = factor(bias, levels = bias.levels)) %>%
    ggplot() +
    geom_bar(aes(x=bias, fill=bias), stat = 'count') +
    geom_text(stat='count',
              aes(x=bias, label=..count..),
              vjust=1,
              color=c('white', 'grey40', 'grey40', 'grey40', 'white')) +
    scale_fill_manual(values = c('dodgerblue2', 'lightblue',
                                 'gray',
                                 'indianred1', 'firebrick')) +
    theme_grey() +
    theme(legend.position = 'none') +
    labs(x='Article Bias', y='# of Articles') +
    scale_y_continuous(labels = scales::comma,
                       limits = c(0, 50000))
bias.cnt
```

### Count of Hyperpartisan Articles

```{r}
#Plot hyperpartisan
hyp.cnt <-
    lean %>%
    mutate(hyperpartisan = factor(hyperpartisan, levels = c('true', 'false'))) %>%
    ggplot() +
    geom_bar(aes(x=hyperpartisan, fill=hyperpartisan), stat = 'count') +
    geom_text(stat='count',
              aes(x=hyperpartisan, label=scales::comma(..count..)),
              vjust=1,
              color=c('white', 'white')) +
    scale_fill_manual(values = c('olivedrab3', 'grey30')) +
    theme_grey() +
    theme(legend.position = 'none') +
    labs(x='Article Hyperpartisan', y='# of Articles') +
    scale_y_continuous(labels = scales::comma,
                       limits = c(0, 75000))
hyp.cnt
```

```{r}
#Table counting bias vs hyperpartisan
lean %>%
    mutate(bias = factor(bias, levels = bias.levels)) %>%
    group_by(hyperpartisan, bias) %>%
    count() %>%
    spread(bias, n) %>%
    knitr::kable(.)
```

### 15 Most Frequent Publishers

```{r}
#Most frequent sources
art.bias.cnt <-
    lean %>%
    mutate(source = str_split(str_split(url, '//', simplify = T)[,2],
                              fixed('.'), simplify = T)[,1],
           bias = factor(bias, levels = bias.levels)) %>%
    group_by(source, bias) %>%
    count() %>%
    arrange(desc(n)) %>%
    head(15) %>%
    ggplot(aes(x= reorder(source, -n), y=n, fill=bias)) +
    geom_bar(stat = 'identity') +
    scale_fill_manual(values = c('dodgerblue2', 'lightblue',
                                 'gray',
                                 'indianred1', 'firebrick')) +
    theme_grey() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = c(0.8, 0.6),
          legend.background = element_rect(color = 'grey30')) +
    labs(x=NULL, y='# of Articles') +
    scale_y_continuous(labels = scales::comma,
                       limits = c(0, 26000))
art.bias.cnt
```

### Count of Articles by Year Published

```{r}
#Content----
art.year.cnt <-
    content %>%
    select(id, `published-at`) %>%
    mutate(Year = lubridate::year(`published-at`),
           Year = ifelse(is.na(Year), 2021, Year),
           PublishDate = ifelse(Year == 2021, 'No', 'Yes')) %>%
    filter(Year >= 1960) %>%
    group_by(Year, PublishDate) %>%
    count(.) %>%
    ggplot() +
    geom_bar(aes(x=Year, y=n, fill=PublishDate), stat = 'identity') +
    scale_y_continuous(labels = scales::comma,
                       limits = c(0, 51000)) +
    labs(y='# Articles', x='Year Article Published') +
    theme_gray() +
    scale_fill_manual(values = c('darkorange', 'navy'))
art.year.cnt
```

### Article Leaning vs Publication Year; Filled by Article Count

```{r}
bias.yr.tile <-
    left_join(content %>% select(id, `published-at`),
          lean %>% select(id, bias),
          by='id') %>%
    mutate(Year = lubridate::year(`published-at`),
           Year = ifelse(is.na(Year), 2021, Year),
           PublishDate = ifelse(Year == 2021, 'No', 'Yes'),
           bias = factor(bias, levels = bias.levels)) %>%
    filter(Year >= 1960) %>%
    group_by(Year, bias) %>%
    count(.) %>%
    rename('Number of Articles' = n) %>%
    ggplot() +
    geom_tile(aes(x=Year, y=bias, fill=`Number of Articles`)) +
    geom_hline(yintercept = seq(0.5, 5.5, 1)) +
    theme_grey() +
    labs(x='Year Article Published', y='Leaning') +
    geom_vline(xintercept = 2008.5, color='red') +
    geom_text(aes(x=2007.5, y='least',
                  label='Cut Off Year (2009)'),
              angle=90, color='red')
bias.yr.tile
```

# Reduced Data Set

```{r}
reduced.df <-
    left_join(content, lean, by='id') %>%
    mutate(Year = lubridate::year(`published-at`),
           Year = ifelse(is.na(Year), 2021, Year),
           PublishDate = ifelse(Year == 2021, 'No', 'Yes'),
           bias = factor(bias, levels = bias.levels)) %>%
    filter(!is.na(`published-at`),
           Year >= 2008)
```

### Count of Articles in Leaning Categories

```{r}
#Plot the bias
red.bias.cnt <-
    reduced.df %>%
    ggplot() +
    geom_bar(aes(x=bias, fill=bias), stat = 'count') +
    geom_text(stat='count',
              aes(x=bias, label=..count..),
              vjust=1,
              color=c('white', 'grey40', 'grey40', 'grey40', 'white')) +
    scale_fill_manual(values = c('dodgerblue2', 'lightblue',
                                 'gray',
                                 'indianred1', 'firebrick')) +
    theme_grey() +
    theme(legend.position = 'none') +
    labs(x='Article Bias', y=NULL,
         title = 'Reduced') +
    scale_y_continuous(labels = scales::comma,
                       limits = c(0, 50000))
```

```{r}
grid.arrange(bias.cnt +
                 labs(title = 'Full'),
             red.bias.cnt,
             ncol=2)
```

### Count of Hyperpartisan Articles

```{r}
#Plot hyperpartisan
red.hyp.cnt <-
    reduced.df %>%
    mutate(hyperpartisan = factor(hyperpartisan, levels = c('true', 'false'))) %>%
    ggplot() +
    geom_bar(aes(x=hyperpartisan, fill=hyperpartisan), stat = 'count') +
    geom_text(stat='count',
              aes(x=hyperpartisan, label=scales::comma(..count..)),
              vjust=1,
              color=c('white', 'white')) +
    scale_fill_manual(values = c('olivedrab3', 'grey30')) +
    theme_grey() +
    theme(legend.position = 'none') +
    labs(x='Article Hyperpartisan', y=NULL,
         title = 'Reduced') +
    scale_y_continuous(labels = scales::comma,
                       limits = c(0, 75000))
```

```{r}
grid.arrange(hyp.cnt +
                 labs(title = 'Full'),
             red.hyp.cnt,
             ncol=2)
```

```{r}
#Table counting bias vs hyperpartisan
reduced.df %>%
    group_by(hyperpartisan, bias) %>%
    count() %>%
    spread(bias, n) %>%
    knitr::kable(.)
```

### 15 Most Frequent Publishers

```{r}
#Most frequent sources
red.art.bias.cnt <-
    reduced.df %>%
    mutate(source = str_split(str_split(url, '//', simplify = T)[,2],
                              fixed('.'), simplify = T)[,1]) %>%
    group_by(source, bias) %>%
    count() %>%
    arrange(desc(n)) %>%
    head(15) %>%
    ggplot(aes(x= reorder(source, -n), y=n, fill=bias)) +
    geom_bar(stat = 'identity') +
    scale_fill_manual(values = c('dodgerblue2', 'lightblue',
                                 'gray',
                                 'indianred1', 'firebrick')) +
    theme_grey() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = 'none',
          legend.background = element_rect(color = 'grey30')) +
    labs(x=NULL, y=NULL,
         title = 'Reduced') +
    scale_y_continuous(labels = scales::comma,
                       limits = c(0, 26000))
```

```{r}
grid.arrange(art.bias.cnt +
                 labs(title = 'Full'),
             red.art.bias.cnt,
             ncol=2)
```

### Count of Articles by Year Published

```{r}
#Content----
red.art.year.cnt <-
    reduced.df %>%
    group_by(Year, PublishDate) %>%
    count(.) %>%
    ggplot() +
    geom_bar(aes(x=Year, y=n, fill=PublishDate), stat = 'identity') +
    scale_y_continuous(labels = scales::comma,
                       limits = c(0, 51000)) +
    labs(y=NULL, x='Year Article Published',
         title = 'Reduced') +
    theme_gray() +
    scale_fill_manual(values = c('navy')) +
    theme(legend.position = 'none',
          legend.background = element_rect(color = 'grey30')) +
    scale_x_continuous(breaks = seq(2009, 2018, 2))
```

```{r}
grid.arrange(art.year.cnt +
                 theme(legend.position = c(0.4, 0.6),
                       legend.background = element_rect(color = 'grey30')) +
                 labs(title = 'Full'),
             red.art.year.cnt,
             ncol=2)
```

### Article Leaning vs Publication Year; Filled by Article Count

```{r}
red.bias.yr.tile <-
    reduced.df %>%
    group_by(Year, bias) %>%
    count(.) %>%
    rename('Number of Articles' = n) %>%
    ggplot() +
    geom_tile(aes(x=Year, y=bias, fill=`Number of Articles`)) +
    geom_hline(yintercept = seq(0.5, 5.5, 1)) +
    theme_grey() +
    labs(x='Year Article Published', y=NULL, title = 'Reduced') +
    geom_vline(xintercept = 2008.5, color='red') +
    geom_text(aes(x=2008, y='least',
                  label='Cut Off Year (2009)'),
              angle=90, color='red')
```

```{r}
grid.arrange(bias.yr.tile +
                 theme(legend.position = 'none') +
                 labs(title = 'Full'),
             red.bias.yr.tile,
             ncol=2)
```

# Media Bias Fact Check

```{r}
bias.levels <- c('left', 'leftcenter', 'least', 'rightcenter', 'right')
#Extract URL main and join mbfc to zenodo
lean.df <-
    lean %>%
    mutate(source = str_split(str_split(url, '//', simplify = T)[,2], fixed('.'), simplify = T)[,1],
           bias = str_replace(bias, '-', '')) %>%
    select(source, zenodo = bias) %>%
    group_by(source, zenodo) %>%
    count(.) %>%
    select(-n) %>%
    left_join(.,
              mbfc %>%
                  mutate(source = str_replace(sourceURL, fixed('www.'), ''),
                         source = str_split(source, fixed('//'), simplify = T)[,2],
                         source = str_split(source, fixed('.'), simplify = T)[,1]) %>%
                  select(source, mbfc = bias),
              by='source') %>%
    ungroup() %>%
    mutate(zenodo = factor(zenodo, levels = bias.levels),
           mbfc = ifelse(mbfc == 'center', 'least', mbfc),
           mbfc = factor(mbfc, levels = bias.levels))
```

```{r}
#Line aesthetics for plot
dividers.x <- seq(0.5, 5.5, 1)
dividers.y <- seq(0.5, 5.5, 1)
grid.df <-
    bind_rows(data.frame(x = dividers.x, xend = dividers.x, y=0.5, yend=5.5),
              data.frame(x = 0.5, xend = 5.5, y=dividers.y, yend=dividers.y))
#Similaruty counts for plot
sim.df <-
    lean.df %>%
    group_by(mbfc, zenodo) %>%
    count(.)
#Plot confusion matrix
lean.df %>%
    mutate(match = ifelse(mbfc == zenodo, 'yes', 'no')) %>%
    ggplot() +
    geom_point(aes(x=mbfc, y=zenodo, color=match), position = 'jitter', show.legend = F) +
    geom_text(data = sim.df, aes(x=mbfc, y=zenodo, label=n), size = 8) +
    geom_segment(data = grid.df, aes(x=x, y=y, xend=xend, yend=yend)) +
    theme_classic() +
    theme(axis.line = element_blank(),
          axis.ticks = element_blank()) +
    scale_color_manual(values = c('grey30', 'purple', 'grey80')) +
    labs(x='mediabiasfactcheck.com', y='Zenodo Hyperpartisan\nDataset')
```

```{r}
disagree.df <-
    lean.df %>%
    mutate(match = ifelse(mbfc == zenodo, 'yes', 'no')) %>%
    filter(match == 'no' | is.na(match))
disagree.df
```

# Final Train Dataset

```{r}
left_join(content, lean, by='id') %>%
    mutate(Year = lubridate::year(`published-at`),
           Year = ifelse(is.na(Year), 2021, Year),
           PublishDate = ifelse(Year == 2021, 'No', 'Yes'),
           bias_final = factor(bias_final, levels = c('left', 'left-center', 'least', 'right-center', 'right'))) %>%
    filter(!is.na(`published-at`),
           Year >= 2009,
           url_keep == 1) %>%
    ggplot() +
    geom_bar(aes(x=bias_final, fill=bias_final), stat = 'count') +
    geom_text(stat='count',
              aes(x=bias_final, label=..count..),
              vjust=1,
              color=c('white', 'grey40', 'grey40', 'grey40', 'white')) +
    scale_fill_manual(values = c('dodgerblue2', 'lightblue',
                                 'gray',
                                 'indianred1', 'firebrick')) +
    theme_grey() +
    theme(legend.position = 'none') +
    labs(x='Article Bias', y='# of Articles') +
    scale_y_continuous(labels = scales::comma,
                       limits = c(0, 25000))
```
